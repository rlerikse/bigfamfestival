# Sync Spec Context to Central Repository
#
# This workflow syncs COMPLETE spec directories (spec.md, plan.md, tasks.md, contracts/)
# to the central spec-kit-context repo for enterprise-wide visibility.
#
# Why full sync? AI agents cannot authenticate to private GitHub URLs.
# By syncing everything locally, agents have immediate access without auth barriers.
#
# Also generates spec-metadata.json for quick indexing/dashboards.
#
# Setup:
# 1. Copy this file to .github/workflows/sync-spec-context.yml
# 2. Ensure SPEC_KIT_CONTEXT_TOKEN org secret exists
# 3. Merge to main - specs will sync automatically
#
# Documentation: https://github.com/rlerikse/es-spec-kit-context

name: Sync Spec Context

on:
  push:
    # Track ALL branches, not just main
    # This enables discovery of work-in-progress specs in feature branches
    branches: ['**']
    paths:
      - 'specs/**'
      - '.specify/conventions/**'
  
  # Also trigger on PR events to catch branch updates
  pull_request:
    paths:
      - 'specs/**'
      - '.specify/conventions/**'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  sync-context:
    name: Sync Complete Spec Directories
    runs-on: ubuntu-latest
    
    # Only run if specs directory exists
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Check for Specs Directory
        id: check-specs
        run: |
          if [ -d "specs" ]; then
            echo "has_specs=true" >> $GITHUB_OUTPUT
            echo "âœ“ Found specs directory"
          else
            echo "has_specs=false" >> $GITHUB_OUTPUT
            echo "âš  No specs directory found - skipping sync"
          fi
      
      - name: Generate Spec Index (for dashboards)
        if: steps.check-specs.outputs.has_specs == 'true'
        run: |
          node -e "
            const fs = require('fs');
            const path = require('path');
            
            const specsDir = './specs';
            const specs = [];
            
            // Read each spec directory
            const specDirs = fs.readdirSync(specsDir)
              .filter(f => fs.statSync(path.join(specsDir, f)).isDirectory())
              .sort();
            
            for (const dir of specDirs) {
              const specPath = path.join(specsDir, dir, 'spec.md');
              
              if (!fs.existsSync(specPath)) {
                console.log('âš  No spec.md in ' + dir);
                continue;
              }
              
              const content = fs.readFileSync(specPath, 'utf8');
              
              // Extract title (first # heading)
              const titleMatch = content.match(/^#\s+(.+)$/m);
              
              // Extract status
              const statusMatch = content.match(/\*\*Status\*\*:\s*(\w+)/i);
              
              // Extract team (optional)
              const teamMatch = content.match(/\*\*Team\*\*:\s*(.+)$/m);
              
              // Extract description (optional - first paragraph after title)
              const descMatch = content.match(/^#\s+.+\n\n(.+?)(?:\n\n|\n#|\n\*\*)/s);
              
              specs.push({
                id: dir,
                title: titleMatch ? titleMatch[1].trim() : dir,
                status: statusMatch ? statusMatch[1].trim() : 'Draft',
                team: teamMatch ? teamMatch[1].trim() : null,
                description: descMatch ? descMatch[1].trim().substring(0, 200) : null,
                path: 'specs/' + dir,
                branch: '${{ github.ref_name }}',
                isMainBranch: '${{ github.ref_name }}' === 'main'
              });
              
              console.log('âœ“ Extracted: ' + dir + ' (' + (statusMatch ? statusMatch[1] : 'Draft') + ')');
            }
            
            const output = {
              repo: '${{ github.repository }}',
              branch: '${{ github.ref_name }}',
              specs: specs,
              updatedAt: new Date().toISOString(),
              commitSha: '${{ github.sha }}',
              commitMessage: process.env.COMMIT_MSG || ''
            };
            
            fs.writeFileSync('spec-metadata.json', JSON.stringify(output, null, 2));
            
            console.log('');
            console.log('ðŸ“‹ Extracted ' + specs.length + ' specs from ${{ github.repository }}');
          "
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
      
      - name: Display Extracted Metadata
        if: steps.check-specs.outputs.has_specs == 'true'
        run: cat spec-metadata.json
      
      - name: Sync Specs and Metadata to Central Repository
        id: push-specs
        if: steps.check-specs.outputs.has_specs == 'true'
        run: |
          # Clone the central repo (sync branch - where aggregation happens)
          git clone --depth 1 --branch sync "https://x-access-token:${{ secrets.SPEC_KIT_CONTEXT_TOKEN }}@github.com/rlerikse/es-spec-kit-context.git" central-repo
          
          # Create destination directories
          REPO_NAME="${{ github.event.repository.name }}"
          BRANCH_NAME="${{ github.ref_name }}"
          SPEC_DIR="central-repo/repos/${REPO_NAME}/${BRANCH_NAME}"
          mkdir -p "$SPEC_DIR"
          
          # Copy spec-metadata.json (branch-specific)
          cp spec-metadata.json "$SPEC_DIR/"
          echo "âœ“ Synced spec-metadata.json to $SPEC_DIR/"
          
          # Copy ALL spec files (spec.md, plan.md, tasks.md, contracts/, etc.)
          if [ -d "specs" ]; then
            for spec_dir in specs/*/; do
              if [ -d "$spec_dir" ]; then
                spec_name=$(basename "$spec_dir")
                mkdir -p "$SPEC_DIR/$spec_name"
                cp -r "$spec_dir"* "$SPEC_DIR/$spec_name/" 2>/dev/null || true
              fi
            done
            echo "âœ“ Synced complete spec directories to $SPEC_DIR/"
          fi
          
          # Copy conventions if they exist
          if [ -d ".specify/conventions" ]; then
            mkdir -p "$SPEC_DIR/conventions"
            cp -r .specify/conventions/* "$SPEC_DIR/conventions/" 2>/dev/null || true
            echo "âœ“ Synced conventions to $SPEC_DIR/conventions/"
          fi
          
          # Commit and push
          cd central-repo
          git config user.name 'spec-bot'
          git config user.email 'spec-bot@users.noreply.github.com'
          git add repos/
          
          if git diff --cached --quiet; then
            echo "â„¹ï¸ No spec changes to push"
            echo "pushed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "chore(context): Update specs from ${{ github.repository }}@${BRANCH_NAME} [${{ github.sha }}]"
            git push origin sync
            echo "âœ… Specs and metadata pushed to central repository (sync branch)"
            echo "pushed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Trigger Aggregation Workflow
        if: steps.push-specs.outputs.pushed == 'true'
        run: |
          echo "ðŸ“¡ Triggering aggregate workflow in spec-kit-context..."
          curl -sL -X POST \
            -H "Authorization: token ${{ secrets.SPEC_KIT_CONTEXT_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/rlerikse/es-spec-kit-context/dispatches" \
            -d '{"event_type":"specs-updated","client_payload":{"repo":"${{ github.repository }}"}}'
          echo "âœ… Aggregation triggered!"
      
      - name: Sync Complete
        if: steps.check-specs.outputs.has_specs == 'true'
        run: |
          echo ""
          echo "âœ… Spec context synced to central repository!"
