---
description: Update context files for monorepo workspace and/or individual repositories to ensure GitHub Copilot has accurate specification awareness.
---

# /speckit.context - Update Specification Context

**Purpose**: Refresh context files that aggregate specification metadata across the workspace (if monorepo) and within individual repositories. This ensures GitHub Copilot has accurate, up-to-date awareness of all specifications, their status, and cross-repo dependencies.

---

## Trigger

```
/speckit.context
```

**Examples**:
- `/speckit.context` - Update all context files (workspace + current repo)
- Called automatically after: `/speckit.specify`, `/speckit.implement`, `/speckit.migrate`, spec status changes

---

## Context Required

Before executing, load:
1. **Repository Type Detection**: Determine if standalone repo or monorepo workspace
2. **Current Directory**: Identify current repository context
3. **Workspace Structure**: Map all repositories (if monorepo)
4. **Existing Context Files**: Check for workspace and repo-level context

---

## Execution Flow

### Phase 0: Repository Type Detection

1. **Detect Workspace Type**:
   ```bash
   # Check for workspace indicators
   if [ -f "../.specify/workspace/all-specs.md" ] || [ -f "../../.specify/workspace/all-specs.md" ]; then
     # Monorepo workspace
     WORKSPACE_TYPE="monorepo"
   elif [ -f ".specify/workspace/all-specs.md" ]; then
     # Current directory is workspace root
     WORKSPACE_TYPE="monorepo"
   else
     # Standalone repository
     WORKSPACE_TYPE="standalone"
   fi
   ```

2. **Identify Workspace Root**:
   - **Monorepo**: Find directory containing `.specify/workspace/`
   - **Standalone**: Current repository root (contains `.git/`)

3. **List All Repositories**:
   - **Monorepo**: All subdirectories with `specs/` directory
   - **Standalone**: Current repository only

---

### Phase 1: Workspace-Level Context Update (Monorepo Only)

**Skip this phase if `WORKSPACE_TYPE="standalone"`**

#### 1.1 Update Workspace All-Specs Context

**Target**: `.specify/workspace/all-specs.md`

**Actions**:

1. **Execute Workspace Update Script**:
   ```bash
   cd "$WORKSPACE_ROOT"
   ./scripts/update-workspace-context.sh
   ```

2. **Verify Script Execution**:
   - Check exit code (should be 0)
   - Verify file was updated (check timestamp)
   - Validate file size > 0

3. **Validate Generated Content**:
   - Must contain sections for each repository with specs
   - Must list all spec directories with metadata:
     - Spec ID (e.g., `001-feature-name`)
     - Title extracted from `spec.md`
     - Status (Planning, In Progress, Implemented)
     - Relative path link to spec
   - Must have "Last Updated" timestamp

**Expected Structure**:
```markdown
# Workspace Specifications

**Auto-generated context for GitHub Copilot**  
**Last Updated**: 2026-01-13 14:30:00

---

## repository-name-1 (3 specs)

### 001-feature-name
- **Title**: Feature Title from spec.md
- **Status**: In Progress
- **Path**: [repository-name-1/specs/001-feature-name](../repository-name-1/specs/001-feature-name/spec.md)

### 002-another-feature
...

## repository-name-2 (5 specs)
...
```

#### 1.2 Update Workspace Repository Index

**Target**: `.specify/workspace/repo-index.json`

**Validation** (automatically generated by update script):

1. **Check JSON Structure**:
   ```json
   {
     "repos": [
       {
         "name": "repository-name",
         "specs": [
           {
             "id": "001-feature-name",
             "title": "Feature Title",
             "status": "In Progress",
             "path": "../repository-name/specs/001-feature-name"
           }
         ]
       }
     ],
     "lastUpdated": "2026-01-13T14:30:00Z",
     "totalRepos": 3,
     "totalSpecs": 12
   }
   ```

2. **Verify Counts**:
   - `totalRepos` matches actual repository count
   - `totalSpecs` matches sum of all specs across repos
   - Each repo's spec array length matches markdown count

#### 1.3 Verify Workspace Context Accuracy

1. **Cross-Reference Check**:
   - Compare `all-specs.md` spec count with `repo-index.json` totals
   - Ensure both files reference same specs
   - Verify no orphaned specs (in file system but not indexed)

2. **Report Status**:
   ```
   âœ… Workspace context updated successfully
   ðŸ“Š Indexed: 3 repositories, 12 specifications
   ðŸ“ Updated: .specify/workspace/all-specs.md
   ðŸ“ Updated: .specify/workspace/repo-index.json
   ```

#### 1.4 Install Workspace Hooks (Optional)

**Target**: Git hooks in all repositories for automatic context updates

**Actions**:

1. **Check if hooks are already installed**:
   ```bash
   cd "$WORKSPACE_ROOT"
   if [ -f "./scripts/install-workspace-hooks.sh" ]; then
     # Check if user wants to install/update hooks
     # Skip if hooks already installed and working
   fi
   ```

2. **Execute Hook Installation Script** (if user confirms or first-time setup):
   ```bash
   cd "$WORKSPACE_ROOT"
   ./scripts/install-workspace-hooks.sh
   ```

3. **Verify Hook Installation**:
   - Check that `.git/hooks/post-commit` exists in each repository
   - Verify hooks are executable (`chmod +x`)
   - Test that hooks reference workspace context update script

4. **Report Hook Status**:
   ```
   âœ… Workspace hooks installed in 3 repositories
   ðŸ“ Auto-update enabled on: commit, merge, checkout
   ```

**Note**: Hooks enable automatic context updates when:
- Committing changes to spec files
- Merging branches with spec changes
- Checking out branches with different specs

---

### Phase 2: Repository-Level Context Update

**Applies to**: Current repository (standalone) OR each repository (monorepo)

For each repository, create/update repo-specific context files.

#### 2.1 Create Repository Spec Index

**Target**: `specs/README.md` (or `.specify/repo-context.md`)

**Purpose**: Quick reference for all specs within this repository

**Actions**:

1. **Scan Specs Directory**:
   ```bash
   REPO_ROOT="/path/to/repository"
   SPECS=$(find "$REPO_ROOT/specs" -mindepth 1 -maxdepth 1 -type d | sort)
   ```

2. **Generate Repository Index**:

```markdown
# Specifications Index for [Repository Name]

**Repository**: repository-name  
**Last Updated**: 2026-01-13 14:30:00  
**Total Specs**: 6

---

## Active Specifications

### 001-feature-name
- **Title**: Feature Title
- **Status**: âœ… Implemented
- **Created**: 2026-01-05
- **Files**: spec.md, plan.md, tasks.md

### 002-another-feature
- **Title**: Another Feature
- **Status**: ðŸš§ In Progress
- **Created**: 2026-01-10
- **Files**: spec.md, plan.md, tasks.md, checklist.md

### 003-new-feature
- **Title**: New Feature
- **Status**: ðŸ“‹ Planning
- **Created**: 2026-01-12
- **Files**: spec.md

---

## Status Summary

- âœ… Implemented: 2
- ðŸš§ In Progress: 3
- ðŸ“‹ Planning: 1

---

## Quick Links

- [Constitution](./.specify/memory/constitution.md) - Quality gates and standards
- [Templates](./.specify/templates/) - Spec-Kit templates
- [Scripts](./.specify/scripts/bash/) - Automation scripts

```

3. **Write Index File**:
   ```bash
   cat > "$REPO_ROOT/specs/README.md" << 'EOF'
   [generated content]
   EOF
   ```

#### 2.2 Update Repository Agent Context

**Target**: AI assistant context files

**Actions**:

1. **Execute Agent Context Update Script**:
   ```bash
   cd "$REPO_ROOT"
   ./.specify/scripts/bash/update-agent-context.sh
   ```

2. **Verify Script Execution**:
   - Check exit code (should be 0)
   - Verify `.specify/agent-context.md` was updated
   - Validate file contains current spec information

#### 2.3 Update Repository Copilot Context

**Target**: `.github/copilot-instructions.md`

**Actions**:

1. **Check if Copilot Instructions Exist**:
   ```bash
   if [ -f "$REPO_ROOT/.github/copilot-instructions.md" ]; then
     UPDATE_MODE=true
   else
     UPDATE_MODE=false
   fi
   ```

2. **Update Context Section** (if exists):
   - Locate "## Specifications" or "## Context" section
   - Update spec count and latest spec references
   - Preserve other sections unchanged

3. **Add Context Block** (if missing):
   ```markdown
   ## Current Specifications

   This repository has **6 active specifications**:
   
   - 001-feature-name (Implemented)
   - 002-another-feature (In Progress)
   - 003-new-feature (Planning)
   - ... [list all specs]

   See [specs/README.md](../specs/README.md) for full index.
   
   ---
   ```

#### 2.4 Create Spec Dependencies Map (Optional)

**Target**: `.specify/spec-dependencies.json`

**Purpose**: Track cross-spec and cross-repo dependencies

**Actions**:

1. **Scan All Spec Files for References**:
   - Search for `Related:`, `Depends on:`, `Blocks:` sections
   - Parse markdown links to other specs
   - Identify cross-repository references

2. **Generate Dependency Graph**:
   ```json
   {
     "specs": {
       "001-feature-name": {
         "dependencies": ["002-other-feature"],
         "blocks": [],
         "relatedSpecs": ["003-related-feature"],
         "crossRepoRefs": [
           "other-repo/specs/005-shared-service"
         ]
       }
     },
     "lastUpdated": "2026-01-13T14:30:00Z"
   }
   ```

---

### Phase 3: Validation and Reporting

#### 3.1 Validate Context Integrity

1. **File System vs Index Consistency**:
   - Compare actual `specs/` directories with indexed specs
   - Identify orphaned directories (no spec.md)
   - Identify unindexed specs (directory exists but not in context)

2. **Link Validation**:
   - Verify all markdown links in context files resolve
   - Check cross-repository references (monorepo)
   - Validate spec.md files exist at referenced paths

3. **Metadata Completeness**:
   - Every spec has title extraction attempted
   - Every spec has status (even if "Unknown")
   - Timestamps are valid ISO 8601 format

#### 3.2 Generate Update Report

**Report Structure**:

```
ðŸ”„ Context Update Complete

Workspace (Monorepo):
âœ… Updated: .specify/workspace/all-specs.md
âœ… Updated: .specify/workspace/repo-index.json
ðŸ“Š Total: 3 repositories, 12 specifications

Repository: dealer-settings-ui
âœ… Updated: specs/README.md
âœ… Updated: .github/copilot-instructions.md
ðŸ“Š Specs: 1 specification (Planning: 1)

Repository: fsr-dealer-settings-service
âœ… Updated: specs/README.md
âœ… Updated: .github/copilot-instructions.md
ðŸ“Š Specs: 6 specifications (Implemented: 4, In Progress: 2)

Repository: fsr-mobile-service
âœ… Updated: specs/README.md
âœ… Updated: .github/copilot-instructions.md
ðŸ“Š Specs: 1 specification (Planning: 1)

âš ï¸ Issues Found:
- specs/004-old-feature: Missing spec.md file (orphaned directory)
- specs/007-broken-link: Contains broken cross-repo reference

âœ… Context synchronized successfully
```

#### 3.3 Commit Changes (Optional)

**Ask User**:
```
Context files have been updated. Would you like to commit these changes?

Files modified:
- .specify/workspace/all-specs.md
- .specify/workspace/repo-index.json
- dealer-settings-ui/specs/README.md
- fsr-dealer-settings-service/specs/README.md
- fsr-mobile-service/specs/README.md
```

**If Yes**:
```bash
git add .specify/workspace/*.md .specify/workspace/*.json
git add */specs/README.md
git add */.github/copilot-instructions.md
git commit -m "chore(speckit): Update specification context"
```

---

## Error Handling

### Missing Update Script (Monorepo)

**Error**: `scripts/update-workspace-context.sh` not found

**Resolution**:
1. Check if workspace is correctly configured
2. Verify `.specify/workspace/` directory exists
3. Suggest running `/speckit.validate` to check infrastructure
4. Offer to create missing script from template

### Permission Errors

**Error**: Cannot write to context files

**Resolution**:
1. Check file permissions
2. Verify not in read-only workspace
3. Suggest using `chmod +w` on context directories

### Spec Parsing Errors

**Error**: Cannot extract title or status from spec.md

**Resolution**:
1. Continue with directory name as title
2. Mark status as "Unknown"
3. Add to warnings in final report
4. Continue processing other specs

---

## Success Criteria

âœ… **Workspace-Level Context** (Monorepo):
- `all-specs.md` contains all specs from all repos
- `repo-index.json` has valid JSON with matching counts
- Timestamps reflect current update time

âœ… **Repository-Level Context**:
- Each repo has `specs/README.md` with complete index
- Copilot instructions updated (if file exists)
- Spec count matches actual directory count

âœ… **Data Integrity**:
- No broken links in context files
- All referenced specs have valid spec.md files
- Status values are valid (Planning, In Progress, Implemented, Unknown)

âœ… **Reporting**:
- User receives clear summary of updates
- Warnings for any issues (orphaned dirs, missing files)
- Success confirmation with updated counts

---

## Integration with Other Commands

**Auto-triggered by**:
- `/speckit.specify` - After creating new spec
- `/speckit.implement` - After completing implementation
- `/speckit.migrate` - After migrating repository
- Manual spec status changes (user should run)

**Triggers downstream**:
- None (this is a terminal operation)

**Required before**:
- `/speckit.plan` - To ensure spec context is current
- `/speckit.analyze` - To validate against latest specs

---

## Notes

- **Performance**: For large monorepos (50+ specs), context update may take 10-30 seconds
- **Concurrency**: Safe to run in parallel across different repositories
- **Idempotency**: Running multiple times produces same result (safe to re-run)
- **Automation**: Consider adding to git pre-commit hooks for automatic updates

**Best Practice**: Run `/speckit.context` after:
- Creating new specifications
- Changing spec status (Planning â†’ In Progress â†’ Implemented)
- Migrating new repositories to Spec-Kit
- Restructuring specs/ directories
